<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriSense | Smart Agriculture Monitoring</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Inbox Modal & Badge */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1e293b;
            padding: 2rem;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            position: relative;
        }

        .msg-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid #10b981;
        }

        .msg-unread {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .msg-sent {
            border-left-color: #3b82f6;
            opacity: 0.8;
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="brand">
                <i class="fa-solid fa-leaf"></i>
                <span>AgriSense</span>
                <img src="assets/nerula_logo.jpg" class="sidebar-team-logo" alt="Team Logo">
            </div>

            <nav class="nav-menu">
                <a href="#" class="nav-item active">
                    <i class="fa-solid fa-gauge-high"></i>
                    <span>Dashboard</span>
                </a>

                <a href="#" class="nav-item">
                    <i class="fa-solid fa-paper-plane"></i>
                    <span>Drones</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fa-solid fa-cube"></i>
                    <span>Mission Planner</span>
                </a>







                <a href="#" class="nav-item">
                    <i class="fa-solid fa-map"></i>
                    <span>Field Map</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fa-solid fa-file-csv"></i>
                    <span>Reports</span>
                </a>


                <a href="#" class="nav-item">
                    <i class="fa-solid fa-gears"></i>
                    <span>System</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fa-solid fa-handshake"></i>
                    <span>Direct Trade</span>
                </a>
            </nav>

            <div class="user-profile">
                <div class="avatar">FM</div>
                <div class="info">
                    <span class="name">Farm Manager</span>
                    <span class="status">Online</span>
                </div>
                <button onclick="logout()"
                    style="margin-left:auto; background:none; border:none; color:#ef4444; cursor:pointer;"
                    title="Logout">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Header -->
            <header class="top-bar">
                <div class="page-title" style="display: flex; align-items: center; gap: 1rem;">
                    <button id="mobile-menu-btn" onclick="toggleMobileMenu()"
                        style="display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <div>
                        <h1>Live Monitoring</h1>
                        <div style="display:flex; align-items:center; gap:0.5rem; color:var(--text-secondary);">
                            <span id="field-subtitle" class="subtitle">Sector A-1 • 1.5 Acres</span>
                            <button onclick="editFieldInfo()"
                                style="background:none; border:none; color:var(--text-secondary); cursor:pointer; font-size:0.8rem; padding:4px;"
                                title="Edit Field Info">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </div>
                    </div>
                </div>



                <div class="system-status">
                    <div class="status-item">
                        <span class="label">System:</span>
                        <span class="value success">Active</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Weather:</span>
                        <span class="value warning">Cloudy</span>
                    </div>
                    <div class="status-item">
                        <button id="voice-assist-btn"
                            style="background:none; border:none; color:white; cursor:pointer; font-size:1.1rem; padding:0 8px;"
                            title="Voice Assistant">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                    </div>
                    <div class="status-item">
                        <span class="label"><i class="fa-solid fa-language"></i></span>
                        <select id="lang-selector"
                            style="background:transparent; border:none; color:white; font-family:inherit; font-weight:600; cursor:pointer; outline:none;">
                            <option value="en" style="background:#0f172a;">English</option>
                            <option value="ta" style="background:#0f172a;">தமிழ் (Tamil)</option>
                            <option value="hi" style="background:#0f172a;">हिंदी (Hindi)</option>
                            <option value="te" style="background:#0f172a;">తెలుగు (Telugu)</option>
                            <option value="ml" style="background:#0f172a;">മലയാളം (Malayalam)</option>
                        </select>
                    </div>
                    <div class="status-item">
                        <button onclick="openUserInbox()"
                            style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer; position:relative;">
                            <i class="fa-solid fa-envelope"></i>
                            <span id="user-msg-badge" class="badge">0</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">

                <!-- Left Column -->
                <div class="dashboard-left">
                    <!-- Drone Feeds (Top Left) -->
                    <section class="panel drone-feeds" id="drone-feeds">
                        <div class="panel-header">
                            <h2><i class="fa-solid fa-video"></i> Drone Live Feed</h2>
                        </div>
                        <div class="camera-grid" id="camera-grid">
                            <!-- Cameras injected by JS -->
                        </div>
                    </section>

                    <!-- Satellite Map (Bottom Left) -->
                    <section class="panel map-panel" id="map-panel">
                        <div class="panel-header">
                            <h2><i class="fa-solid fa-satellite"></i> Satellite Disease Mapping</h2>
                        </div>
                        <div id="map-container"></div>
                    </section>
                </div>

                <!-- Right Column -->
                <div class="dashboard-right">
                    <!-- Weather & Alerts (Top Right) -->
                    <section class="panel weather-panel" id="weather-panel">
                        <!-- Weather content injected by JS -->
                    </section>

                    <!-- AI Analysis & Recommendations (Bottom Right) -->
                    <section class="panel analysis-panel" id="analysis-panel">
                        <div class="panel-header">
                            <h2><i class="fa-solid fa-brain"></i> AI Diagnostics</h2>
                        </div>
                        <div class="analysis-content" id="analysis-content">
                            <!-- Analysis injected by JS -->
                        </div>
                    </section>

                    <!-- Hidden Panels (Keep here for structure) -->
                    <section class="panel reports-panel hidden-panel" id="reports-panel"></section>
                    <section class="panel system-panel hidden-panel" id="system-panel"></section>
                    <section class="panel mission-planner-panel hidden-panel" id="mission-planner-panel"></section>






                    <section class="panel marketplace-panel hidden-panel" id="marketplace-panel"></section>
                </div>

            </div>
        </main>
    </div>

    <!-- USER INBOX MODAL -->
    <div id="user-inbox-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h2 style="margin:0;"><i class="fa-solid fa-inbox"></i> Inbox</h2>
                <button onclick="closeUserInbox()"
                    style="background:none; border:none; color:#94a3b8; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:8px; margin-bottom:1rem;">
                <label style="display:block; font-size:0.8rem; color:#94a3b8; margin-bottom:5px;">New Message to
                    Admin:</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="quick-msg-input" placeholder="Type a message..."
                        style="flex:1; padding:8px; background:#0f172a; border:1px solid #334155; color:white; border-radius:4px;">
                    <button onclick="sendUserMessage()"
                        style="background:var(--primary); color:black; border:none; padding:0 15px; border-radius:4px; font-weight:bold; cursor:pointer;">Send</button>
                </div>
            </div>

            <div id="user-inbox-list" style="max-height:300px; overflow-y:auto;">
                <!-- Messages Injected Here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Config & Services -->
    <script src="js/config.js"></script>
    <script src="js/services/error_service.js"></script>
    <script src="js/services/gemini-api.js"></script>

    <!-- User Messaging Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setInterval(checkUserMessages, 2000);
            checkUserMessages();
        });

        function checkUserMessages() {
            const user = sessionStorage.getItem('agrisense_user');
            if (!user) return;

            const msgs = JSON.parse(localStorage.getItem('agrisense_messages') || '[]');
            // Count unread messages addressed TO this user
            const unread = msgs.filter(m => m.to === user && !m.read).length;
            const badge = document.getElementById('user-msg-badge');

            if (unread > 0) {
                badge.style.display = 'block';
                badge.textContent = unread;
            } else {
                badge.style.display = 'none';
            }
        }

        function openUserInbox() {
            document.getElementById('user-inbox-modal').style.display = 'flex';
            const list = document.getElementById('user-inbox-list');
            const user = sessionStorage.getItem('agrisense_user');
            if (!user) return;

            const allMsgs = JSON.parse(localStorage.getItem('agrisense_messages') || '[]');

            // Show messages sent BY user OR sent TO user
            const myMsgs = allMsgs.filter(m => m.user === user || m.to === user || m.from === user);

            if (myMsgs.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#64748b; padding:20px;">No messages yet.</div>';
                return;
            }

            list.innerHTML = myMsgs.map(m => {
                const isReceived = m.to === user;
                return `
                <div class="msg-item ${isReceived && !m.read ? 'msg-unread' : ''} ${!isReceived ? 'msg-sent' : ''}">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong style="color:${isReceived ? '#10b981' : '#3b82f6'};">
                            ${isReceived ? 'Admin' : 'You'}
                        </strong>
                        <span style="font-size:0.8rem; color:#94a3b8;">${m.time}</span>
                    </div>
                    <div style="color:#cbd5e1; font-size:0.9rem;">${m.text}</div>
                </div>
            `}).join('');

            // Mark received as read
            const updated = allMsgs.map(m => {
                if (m.to === user) return { ...m, read: true };
                return m;
            });
            localStorage.setItem('agrisense_messages', JSON.stringify(updated));
            document.getElementById('user-msg-badge').style.display = 'none';
        }

        function closeUserInbox() {
            document.getElementById('user-inbox-modal').style.display = 'none';
            checkUserMessages();
        }

        function sendUserMessage() {
            const input = document.getElementById('quick-msg-input');
            const text = input.value.trim();
            if (!text) return;

            const user = sessionStorage.getItem('agrisense_user');
            const msgs = JSON.parse(localStorage.getItem('agrisense_messages') || '[]');

            msgs.unshift({
                id: Date.now(),
                user: user, // Identify sender
                to: 'admin', // Explicitly for admin
                text: text,
                time: new Date().toLocaleString(),
                read: false
            });

            localStorage.setItem('agrisense_messages', JSON.stringify(msgs));
            input.value = '';
            openUserInbox(); // Refresh list to show sent message
        }
    </script>

    <!-- Components (Loaded globally for file:// compatibility) -->
    <script src="js/components/drone-feed.js"></script>
    <script src="js/components/map-visualizer.js"></script>
    <script src="js/components/weather.js"></script>
    <script src="js/components/analytics.js"></script>
    <script src="js/components/reports.js"></script>
    <script src="js/components/system-settings.js"></script>


    <script src="js/components/language.js"></script>
    <script src="js/components/mission-planner.js"></script>



    <script src="js/services/price_intelligence.js"></script>
    <script src="js/components/marketplace.js"></script>
    <script src="js/components/voice-assistant.js"></script>

    <!-- Main App -->
    <script src="js/app.js"></script>
</body>

</html>